@startuml
skinparam sequenceMessageAlign center
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2

actor "QL Chi nhánh" as BranchManager
actor "QL Kho Tổng" as MainManager
boundary "GD_Chinh" as GUI_Main
boundary "GD_DanhSachYeuCau" as GUI_List
boundary "GD_ChiTietYeuCau" as GUI_Detail
boundary "GD_ChiDinhKho" as GUI_Assign
control "Ctrl_Request" as RequestController
control "Ctrl_Inventory" as InventoryController
entity "DB_Requests" as RequestDB
entity "DB_Inventory" as InventoryDB

note over BranchManager: PHẦN 1: Quản lý chi nhánh duyệt phiếu

BranchManager -> GUI_Main: 1: Chọn "Duyệt phiếu yêu cầu"
activate BranchManager
activate GUI_Main

GUI_Main -> GUI_List: 1.1: Mở danh sách yêu cầu (status=0)
activate GUI_List
deactivate GUI_Main

GUI_List -> RequestController: 1.2: getRequestsByWarehouse(warehouse_id)
activate RequestController

RequestController -> RequestDB: 1.2.1: find({warehouse_id, status: 0})
activate RequestDB

RequestDB --> RequestController: 1.2.2: return requests
deactivate RequestDB

RequestController --> GUI_List: 1.2.3: return requests
deactivate RequestController

GUI_List -> GUI_List: 1.3: Hiển thị danh sách phiếu chờ duyệt

BranchManager -> GUI_Detail: 2: Click "Xem chi tiết"
activate GUI_Detail
deactivate GUI_List

GUI_Detail -> RequestController: 2.1: getRequestById(request_id)
activate RequestController

RequestController -> RequestDB: 2.1.1: findOne({transaction_id})
activate RequestDB

RequestDB --> RequestController: 2.1.2: return request
deactivate RequestDB

RequestController --> GUI_Detail: 2.1.3: return request
deactivate RequestController

GUI_Detail -> GUI_Detail: 2.2: Hiển thị chi tiết (sản phẩm, số lượng, ưu tiên)

BranchManager -> GUI_Detail: 3: Click "Duyệt phiếu"

GUI_Detail -> GUI_Detail: 3.1: Validate quyết định

alt Duyệt phiếu
    GUI_Detail -> RequestController: 3.2: approveRequest(request_id, approver)
    activate RequestController
    
    RequestController -> RequestDB: 3.2.1: updateOne({$set: {status: 1, approved_by, approved_at}})
    activate RequestDB
    
    note right of RequestDB
    status = 1: Đã duyệt
    (Chờ Kho Tổng kiểm tra)
    end note
    
    RequestDB --> RequestController: 3.2.2: Update success
    deactivate RequestDB
    
    RequestController --> GUI_Detail: 3.2.3: return [true]
    deactivate RequestController
    
    GUI_Detail -> GUI_Detail: 3.3: Hiển thị "Đã gửi yêu cầu lên Kho Tổng"
    
    GUI_Detail -> GUI_Main: 3.4: Chuyển hướng về danh sách
    
else Từ chối phiếu
    GUI_Detail -> RequestController: 3.5: rejectRequest(request_id, approver)
    activate RequestController
    
    RequestController -> RequestDB: 3.5.1: updateOne({$set: {status: 2, rejected_by, rejected_at}})
    activate RequestDB
    
    note right of RequestDB
    status = 2: Từ chối
    end note
    
    RequestDB --> RequestController: 3.5.2: Update success
    deactivate RequestDB
    
    RequestController --> GUI_Detail: 3.5.3: return [true]
    deactivate RequestController
    
    GUI_Detail -> GUI_Detail: 3.6: Hiển thị "Đã từ chối phiếu yêu cầu"
    
    GUI_Detail -> GUI_Main: 3.7: Chuyển hướng về danh sách
end

deactivate GUI_Detail
deactivate BranchManager

note over MainManager: PHẦN 2: Quản lý Kho Tổng kiểm tra và phân bổ

MainManager -> GUI_Main: 4: Chọn "Yêu cầu đến"
activate MainManager
activate GUI_Main

GUI_Main -> GUI_List: 4.1: Mở danh sách (status=1)
activate GUI_List
deactivate GUI_Main

GUI_List -> RequestController: 4.2: getRequestsBySourceWarehouse(warehouse_id, [1])
activate RequestController

RequestController -> RequestDB: 4.2.1: find({source_warehouse_id, status: 1})
activate RequestDB

RequestDB --> RequestController: 4.2.2: return requests
deactivate RequestDB

RequestController --> GUI_List: 4.2.3: return requests
deactivate RequestController

GUI_List -> GUI_List: 4.3: Hiển thị danh sách phiếu chờ kiểm tra

MainManager -> GUI_Detail: 5: Click "Xem chi tiết"
activate GUI_Detail
deactivate GUI_List

GUI_Detail -> RequestController: 5.1: getRequestById(request_id)
activate RequestController

RequestController -> RequestDB: 5.1.1: findOne({transaction_id})
activate RequestDB

RequestDB --> RequestController: 5.1.2: return request
deactivate RequestDB

RequestController --> GUI_Detail: 5.1.3: return request
deactivate RequestController

GUI_Detail -> InventoryController: 5.2: getTotalStockByProduct(source_warehouse, product_id)
activate InventoryController

loop Mỗi sản phẩm trong request
    InventoryController -> InventoryDB: 5.2.1: aggregate stock
    activate InventoryDB
    
    InventoryDB --> InventoryController: 5.2.2: return stock
    deactivate InventoryDB
end

InventoryController --> GUI_Detail: 5.2.3: return stock data
deactivate InventoryController

GUI_Detail -> InventoryController: 5.3: getStockByProductAllWarehouses(products)
activate InventoryController

InventoryController -> InventoryDB: 5.3.1: aggregate stock (all warehouses)
activate InventoryDB

InventoryDB --> InventoryController: 5.3.2: return stocks
deactivate InventoryDB

InventoryController --> GUI_Detail: 5.3.3: return warehouse stocks
deactivate InventoryController

GUI_Detail -> GUI_Detail: 5.4: Hiển thị:\n- Tồn kho Kho Tổng\n- Tồn kho các chi nhánh (trừ kho yêu cầu)\n- Gợi ý kho có đủ hàng

MainManager -> GUI_Detail: 6: Chọn kho cung ứng

MainManager -> GUI_Detail: 7: Nhập ghi chú (nếu có)

MainManager -> GUI_Detail: 8: Click "Xác nhận"

GUI_Detail -> GUI_Detail: 8.1: Validate dữ liệu

alt Dữ liệu hợp lệ
    GUI_Detail -> RequestController: 8.2: confirmAndAssignWarehouse(request_id, warehouses, processed_by, note)
    activate RequestController
    
    RequestController -> RequestDB: 8.2.1: updateOne({$set: {status: 3, assigned_warehouses, processed_by, processed_at, assignment_note}})
    activate RequestDB
    
    note right of RequestDB
    status = 3: Đã xác nhận
    assigned_warehouses: Các kho cung ứng
    (Kho Tổng và/hoặc chi nhánh khác)
    end note
    
    RequestDB --> RequestController: 8.2.2: Update success
    deactivate RequestDB
    
    RequestController --> GUI_Detail: 8.2.3: return [true]
    deactivate RequestController
    
    GUI_Detail -> GUI_Detail: 8.3: Hiển thị "Đã xác nhận phân bổ kho"
    
    GUI_Detail -> GUI_Main: 8.4: Chuyển hướng về danh sách
else Dữ liệu không hợp lệ
    GUI_Detail -> GUI_Detail: 8.5: Hiển thị lỗi
end
deactivate MainManager

@enduml
