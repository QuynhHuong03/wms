@startuml
skinparam sequenceMessageAlign center
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2

actor "QL Kho" as Manager
boundary "GD_Chinh" as GUI_Main
boundary "GD_DanhSachPhieuXuat" as GUI_List
boundary "GD_ChiTietPhieuXuat" as GUI_Detail
control "Ctrl_Export" as ExportController
control "Ctrl_Inventory" as InventoryController
entity "DB_Transactions" as TransactionDB
entity "DB_Inventory" as InventoryDB
entity "DB_Batches" as BatchDB

Manager -> GUI_Main: 1: Chọn "Phiếu xuất chờ xác nhận"
activate Manager
activate GUI_Main

GUI_Main -> GUI_List: 1.1: Mở danh sách (status=0)
activate GUI_List
deactivate GUI_Main

GUI_List -> ExportController: 1.2: getExportsByWarehouse(warehouse_id, status=0)
activate ExportController

ExportController -> TransactionDB: 1.2.1: find({transaction_type: "export", warehouse_id, status: 0})
activate TransactionDB

TransactionDB --> ExportController: 1.2.2: return exports
deactivate TransactionDB

ExportController --> GUI_List: 1.2.3: return exports
deactivate ExportController

GUI_List -> GUI_List: 1.3: Hiển thị danh sách phiếu chờ xuất

Manager -> GUI_Detail: 2: Click "Xem chi tiết"
activate GUI_Detail
deactivate GUI_List

GUI_Detail -> ExportController: 2.1: getExportById(export_id)
activate ExportController

ExportController -> TransactionDB: 2.1.1: findOne({transaction_id})
activate TransactionDB

TransactionDB --> ExportController: 2.1.2: return export
deactivate TransactionDB

ExportController --> GUI_Detail: 2.1.3: return export
deactivate ExportController

GUI_Detail -> GUI_Detail: 2.2: Hiển thị chi tiết phiếu xuất

Manager -> GUI_Detail: 3: Click "Xác nhận xuất kho"

GUI_Detail -> GUI_Detail: 3.1: Validate dữ liệu

alt Dữ liệu hợp lệ
    GUI_Detail -> ExportController: 3.2: confirmExport(export_id, confirmed_by)
    activate ExportController
    
    ExportController -> InventoryController: 3.2.1: deductInventoryFIFO(warehouse_id, products)
    activate InventoryController
    
    loop Mỗi sản phẩm
        InventoryController -> BatchDB: 3.2.1.1: find({warehouse_id, product_id, quantity_remaining > 0})
        activate BatchDB
        
        note right of BatchDB
        Sort: import_date ASC (FIFO)
        Lấy các lô hàng cũ nhất
        end note
        
        BatchDB --> InventoryController: 3.2.1.2: return batches
        deactivate BatchDB
        
        InventoryController -> BatchDB: 3.2.1.3: updateOne({$inc: {quantity_remaining: -qty}})
        activate BatchDB
        
        BatchDB --> InventoryController: 3.2.1.4: Update success
        deactivate BatchDB
        
        InventoryController -> InventoryDB: 3.2.1.5: updateOne({$inc: {qty: -qty}})
        activate InventoryDB
        
        InventoryDB --> InventoryController: 3.2.1.6: Update success
        deactivate InventoryDB
    end
    
    InventoryController --> ExportController: 3.2.2: return [true]
    deactivate InventoryController
    
    ExportController -> TransactionDB: 3.2.3: updateOne({$set: {status: 1, inventory_deducted: true, confirmed_by, confirmed_at}})
    activate TransactionDB
    
    note right of TransactionDB
    status = 1: Hoàn thành
    inventory_deducted = true
    (Đã trừ tồn kho theo FIFO)
    end note
    
    TransactionDB --> ExportController: 3.2.4: Update success
    deactivate TransactionDB
    
    ExportController -> TransactionDB: 3.2.5: updateOne({transaction_id: request_id}, {$set: {status: 7, completed_at}})
    activate TransactionDB
    
    note right of TransactionDB
    Cập nhật request:
    status = 7: Hoàn tất
    end note
    
    TransactionDB --> ExportController: 3.2.6: Update success
    deactivate TransactionDB
    
    ExportController --> GUI_Detail: 3.2.7: return [true]
    deactivate ExportController
    
    GUI_Detail -> GUI_Detail: 3.3: Hiển thị "Đã xác nhận xuất kho thành công"
    
    GUI_Detail -> GUI_Main: 3.4: Chuyển hướng về danh sách
else Dữ liệu không hợp lệ
    GUI_Detail -> GUI_Detail: 3.5: Hiển thị lỗi
end

deactivate GUI_Detail
deactivate Manager

@enduml
