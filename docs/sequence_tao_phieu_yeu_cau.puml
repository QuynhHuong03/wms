@startuml
skinparam sequenceMessageAlign center
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2

actor "NV Kho chi nhánh" as Staff
boundary "GD_Chinh" as GUI_Main
boundary "GD_TaoYeuCau" as GUI_Create
control "Ctrl_Product" as ProductController
control "Ctrl_Inventory" as InventoryController
control "Ctrl_Request" as RequestController
entity "DB_Products" as ProductDB
entity "DB_Inventory" as InventoryDB
entity "DB_Requests" as RequestDB

Staff -> GUI_Main: 1: Chọn "Tạo yêu cầu nhập hàng"
activate Staff
activate GUI_Main

GUI_Main -> GUI_Create: 1.1: Mở form tạo yêu cầu
activate GUI_Create
deactivate GUI_Main

GUI_Create -> ProductController: 1.2: getProductsBelowMinStock(warehouse_id)
activate ProductController

ProductController -> InventoryController: 1.2.1: getProductsStockByWarehouse()
activate InventoryController

InventoryController -> InventoryDB: 1.2.1.1: find({warehouse_id})
activate InventoryDB

InventoryDB --> InventoryController: 1.2.1.2: return stock
deactivate InventoryDB

InventoryController --> ProductController: 1.2.2: return stock data
deactivate InventoryController

ProductController -> ProductDB: 1.2.3: find({current_stock < min_stock})
activate ProductDB

ProductDB --> ProductController: 1.2.4: return products
deactivate ProductDB

ProductController --> GUI_Create: 1.2.5: return products below min
deactivate ProductController

GUI_Create -> ProductController: 1.3: getAllProducts()
activate ProductController

ProductController -> ProductDB: 1.3.1: find({})
activate ProductDB

ProductDB --> ProductController: 1.3.2: return all products
deactivate ProductDB

ProductController --> GUI_Create: 1.3.3: return products
deactivate ProductController

GUI_Create -> GUI_Create: 1.4: Hiển thị 2 phần (sản phẩm cần nhập + tất cả)

Staff -> GUI_Create: 2: Tick chọn sản phẩm

Staff -> GUI_Create: 3: Chọn đơn vị và nhập số lượng

GUI_Create -> GUI_Create: 3.1: Tự động quy đổi số lượng

Staff -> GUI_Create: 4: Chọn mức độ ưu tiên (bình thường/khẩn cấp)

Staff -> GUI_Create: 5: Click "Gửi yêu cầu"

GUI_Create -> GUI_Create: 5.1: Validate dữ liệu

alt Dữ liệu hợp lệ
    GUI_Create -> RequestController: 5.2: createRequest(payload)
    activate RequestController
    
    
    RequestController -> InventoryController: 5.2.1: getTotalStockByProduct(source_warehouse, product_id)
    activate InventoryController
    
    InventoryController -> InventoryDB: 5.2.1.1: aggregate stock
    activate InventoryDB
    
    InventoryDB --> InventoryController: 5.2.1.2: return stock
    deactivate InventoryDB
    
    InventoryController --> RequestController: 5.2.2: return source_stock
    deactivate InventoryController
    
    RequestController -> RequestController: 5.2.3: generateRequestId()
    
    RequestController -> RequestDB: 5.2.4: insertOne(doc)
    activate RequestDB
    
    
    RequestDB --> RequestController: 5.2.5: Insert success
    deactivate RequestDB
    
    RequestController --> GUI_Create: 5.2.6: return [true, request_id]
    deactivate RequestController
    
    GUI_Create -> GUI_Create: 5.3: Hiển thị "Yêu cầu đã gửi!"
    
    GUI_Create -> GUI_Main: 5.4: Chuyển hướng về danh sách yêu cầu
else Dữ liệu không hợp lệ
    GUI_Create -> GUI_Create: 5.5: Hiển thị lỗi validation
end

deactivate GUI_Create
deactivate Staff

@enduml
